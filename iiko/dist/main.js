(()=>{"use strict";var e={807:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function a(e){try{d(n.next(e))}catch(e){r(e)}}function s(e){try{d(n.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,s)}d((n=n.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(i(185));t.default=function(){return n(this,void 0,void 0,(function*(){yield r.default.connect(process.env.mongo_connect_url),console.log("success connect to mongo deliverycx")}))}},341:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function a(e){try{d(n.next(e))}catch(e){r(e)}}function s(e){try{d(n.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,s)}d((n=n.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),o(i(142)).default.config({path:__dirname+"/../.env"}),process.chdir(`${__dirname}/../..`);const r=o(i(167)),a=i(473),s=i(229),d=o(i(447)),u=o(i(807)),c=o(i(170)),l=o(i(982)),p=o(i(519)),f=o(i(886)),g=o(i(854)),y=o(i(44));class v{constructor(){this.organizations=[]}static getInstance(){return v._instance||(v._instance=new v),v._instance}get token(){return v.token}getToken(){return n(this,void 0,void 0,(function*(){try{const e=yield r.default.get(`https://iiko.biz:9900/api/0/auth/access_token?user_id=${process.env.iiko_user}&user_secret=${process.env.iiko_password}`);v.token=e.data}catch(e){console.log(`Error with get token\n${e}`)}}))}getOrganizations(){return n(this,void 0,void 0,(function*(){try{console.log("starting get organizations");const e=yield r.default.get(`https://iiko.biz:9900/api/0/organization/list?access_token=${v.token}`);this.organizations=e.data.map((e=>(0,a.parseOrganization)(e)))}catch(e){console.log(`Error with get organizations\n${e}`)}}))}getAndSaveNomenclature(){return n(this,void 0,void 0,(function*(){try{for(let e in this.organizations){const t=yield r.default.get(`https://iiko.biz:9900/api/0/nomenclature/${this.organizations[e].id}?access_token=${v.token}`),i=this.organizations[e],o=yield g.default.findOne({organization:this.organizations[e].id});if((null==o?void 0:o.revision)===t.data.revision)continue;const a={products:t.data.products,groups:t.data.groups,categories:t.data.productCategories,revision:t.data.revision};console.log(i.address);const u=yield l.default.findOneAndUpdate({name:i.address.city},{$setOnInsert:{name:i.address.city}},{new:!0,upsert:!0});yield Promise.all(a.categories.map((e=>n(this,void 0,void 0,(function*(){yield c.default.findOneAndUpdate({_id:e.id},Object.assign(Object.assign({},e),{_id:e.id}),{upsert:!0})}))))),yield p.default.deleteMany({organization:i.id}),yield Promise.all(a.groups.map((e=>n(this,void 0,void 0,(function*(){var t;yield p.default.findOneAndUpdate({_id:e.id},Object.assign(Object.assign({},e),{image:e.images&&e.images.length?null===(t=e.images[e.images.length-1])||void 0===t?void 0:t.imageUrl:"",organization:i.id,_id:e.id}),{upsert:!0})})))));const y=yield Promise.all(a.products.map((e=>n(this,void 0,void 0,(function*(){var t;const i=yield(0,d.default)(e.images&&e.images.length?null===(t=e.images[e.images.length-1])||void 0===t?void 0:t.imageUrl:"");return Object.assign(Object.assign({},e),{image:i,category:e.productCategoryId,group:e.parentGroup})}))))),h=yield g.default.findOneAndUpdate({organization:i.id},{$setOnInsert:{organization:i.id},revision:a.revision,$set:{products:y}},{new:!0,upsert:!0}),m=yield(0,s.geoCode)(i.address.fulladdress),_=i.workTime?i.workTime.split(";")[0]:"";yield f.default.findOneAndUpdate({_id:i.id},{$setOnInsert:{_id:i.id,city:u._id,street:i.address.address,longitude:null==m?void 0:m.longitude,latitude:null==m?void 0:m.latitude,products:h._id},$set:{contacts:Object.assign({},i.contacts),workTime:_}},{new:!0,upsert:!0})}}catch(e){console.log(`Error with get products\n${e}`)}}))}getStopLists(e=""){return n(this,void 0,void 0,(function*(){try{(yield f.default.find({})).forEach((e=>{console.log(`Starting get stopLists for organization: ${e._id}`),r.default.get(`https://iiko.biz:9900/api/0/stopLists/getDeliveryStopList?access_token=${v.token}&organization=${e._id}`).then((({data:{stopList:t}})=>n(this,void 0,void 0,(function*(){const i=t.map((e=>e.items));yield y.default.findOneAndUpdate({organization:e._id},{$setOnInsert:{organization:e._id},$set:{products:i}},{upsert:!0}),console.log(`End get stopLists for organization: ${e._id}`)})))).catch((t=>{console.log(`Error in stop lists ${e._id}\n${t}`)}))}))}catch(e){return console.log(e),[]}}))}pooling(){return n(this,void 0,void 0,(function*(){console.log("start pooling"),yield this.getToken(),yield this.getOrganizations(),yield this.getAndSaveNomenclature(),console.log("end pooling")}))}}v.token="";const h=v.getInstance();(0,u.default)().then((()=>n(void 0,void 0,void 0,(function*(){yield h.pooling(),process.exit(1)})))).catch((e=>{console.log(e),process.exit(0)}))},170:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0});const n=i(185),o=new n.Schema({_id:{required:!0,type:String},name:{required:!0,type:String}},{versionKey:!1});t.default=(0,n.model)("Category",o)},982:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0});const n=i(185),o=new n.Schema({classifierId:{required:!0,type:String},additionalInfo:{required:!0,type:String},externalRevision:{required:!0,type:Number},name:{required:!0,type:String}},{versionKey:!1});t.default=(0,n.model)("City",o)},519:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0});const n=i(185),o=new n.Schema({_id:{required:!0,type:String},name:{required:!0,type:String},description:{type:String},code:{required:!0,type:String},order:{required:!0,type:Number},image:{required:!0,type:String},organization:{required:!0,type:String,ref:"Organization"},isIncludedInMenu:{required:!0,type:Boolean}},{versionKey:!1});t.default=(0,n.model)("Group",o)},886:function(e,t,i){var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const a=r(i(185)),s=new a.Schema({_id:{required:!0,type:String},city:{required:!0,type:a.default.Types.ObjectId,ref:"City"},longitude:{required:!0,type:Number},latitude:{required:!0,type:Number},street:{required:!0,type:String},contacts:{phone:{required:!0,type:String},email:String},products:{required:!0,type:a.default.Types.ObjectId,ref:"product"},workTime:{required:!0,type:String}},{versionKey:!1});t.default=(0,a.model)("Organization",s)},854:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ProductSchema=void 0;const n=i(185);t.ProductSchema=new n.Schema({id:String,name:{required:!0,type:String},code:{required:!0,type:String},price:{required:!0,type:Number},image:{required:!0,type:String},isIncludedInMenu:{required:!0,type:Boolean},order:Number,group:{required:!0,type:String,ref:"Group"},category:{required:!0,type:String,ref:"Category"},weight:{required:!0,type:Number},measureUnit:{required:!0,type:String},description:{required:!0,type:String},additionalInfo:{required:!0,type:String}});const o=new n.Schema({organization:{ref:"organization",type:String},products:[t.ProductSchema],revision:Number},{versionKey:!1});t.default=(0,n.model)("Products",o)},44:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0});const n=i(185),o=new n.Schema({organization:{type:String,ref:"Organization"},products:[{productId:String,balance:Number}]},{versionKey:!1});t.default=(0,n.model)("StopList",o)},229:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function a(e){try{d(n.next(e))}catch(e){r(e)}}function s(e){try{d(n.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,s)}d((n=n.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.separateAddress=t.geoCode=void 0;const r=o(i(167)),a=i(435);function s(e,t){var i;const n=(new a.DOMParser).parseFromString(e,"text/xml"),o=t.split(" ");let r=n.documentElement.getElementsByTagName(o[0])[0];if(r=null===(i=r.getElementsByTagName(o[1])[0].firstChild)||void 0===i?void 0:i.textContent,"string"==typeof r){const[e,t]=r.split(" ");return{longitude:+e,latitude:+t}}return null}t.geoCode=function(e){return n(this,void 0,void 0,(function*(){try{const t=encodeURI(e),i=yield r.default.get(`https://geocode-maps.yandex.ru/1.x/?apikey=${process.env.yandex_apiKey}&geocode=${t}`);return 200!==i.status?null:s(i.data,"Point pos")}catch(e){return console.log(e),null}}))},t.separateAddress=function(e){return n(this,void 0,void 0,(function*(){e=encodeURI(e);const{data:t,status:i}=yield r.default.get(`https://geocode-maps.yandex.ru/1.x/?geocode=${e}&format=json&apikey=${process.env.yandex_apiKey}`);if(console.log(t),200!==i)return{status:i,message:"Something went wrong"};if(0==+t.response.GeoObjectCollection.metaDataProperty.GeocoderResponseMetaData.found)return{status:400,message:"Не верно задан адрес"};const n={};return t.response.GeoObjectCollection.featureMember[0].GeoObject.metaDataProperty.GeocoderMetaData.Address.Components.forEach((e=>{n[e.kind]=e.name})),{status:200,message:"OK",separateAddressObject:n}}))},t.default=s},473:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.parseOrganization=void 0,t.parseOrganization=function(e){var t;const i=null===(t=e.address.match(/^(?<city>.+?),\s?(?<address>.+)$/i))||void 0===t?void 0:t.groups;return Object.assign(Object.assign({},e),{id:e.id,address:{fulladdress:e.address,city:i?i.city.trim():null,address:i?i.address.trim():null},contacts:{phone:e.contact.phone,email:e.contact.email}})}},447:function(e,t,i){var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return o(t,e),t},a=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function a(e){try{d(n.next(e))}catch(e){r(e)}}function s(e){try{d(n.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,s)}d((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.clearDir=void 0;const s=r(i(147)),d=r(i(12)),u=r(i(17)),c=r(i(828));t.clearDir=function(){return a(this,void 0,void 0,(function*(){s.readdir("../static",((e,t)=>{if(e)throw e;for(const e of t)s.unlink(u.join("../static",e),(e=>{if(e)throw e}))}))}))},t.default=function(e){return a(this,void 0,void 0,(function*(){if(""===e)return"";const t=yield d.read(e),i=t._originalMime.split("/")[1],n=`${c.v4()}_${Date.now()}.${i}`;return yield t.resize(300,d.AUTO),yield t.writeAsync(`${process.cwd()}/static/${n}`),`/static/shop/${n}`}))}},167:e=>{e.exports=require("axios")},142:e=>{e.exports=require("dotenv")},12:e=>{e.exports=require("jimp")},185:e=>{e.exports=require("mongoose")},828:e=>{e.exports=require("uuid")},435:e=>{e.exports=require("xmldom")},147:e=>{e.exports=require("fs")},17:e=>{e.exports=require("path")}},t={};!function i(n){var o=t[n];if(void 0!==o)return o.exports;var r=t[n]={exports:{}};return e[n].call(r.exports,r,r.exports,i),r.exports}(341)})();