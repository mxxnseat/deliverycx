(()=>{"use strict";var e={493:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t},s=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(45)),u=n(45);t.default=class{getCities(e,t){return s(this,void 0,void 0,(function*(){try{const n=e.query.city,o=yield a.City.find({name:{$regex:n,$options:"i"}});t.json(o)}catch(e){console.log(e)}}))}getAddresses(e,t){return s(this,void 0,void 0,(function*(){const n=e.query.city;if(!n)return t.status(400).json("Bad request");try{const e=yield a.Organization.find({city:n}).populate("city");t.json(e)}catch(e){console.log(e)}}))}getCategories(e,t){return s(this,void 0,void 0,(function*(){try{const{username:n}=e.body,o=yield u.User.findOne({username:n}),r=yield a.Group.find({organization:o.organization,description:{$ne:"HIDDEN"}}).sort({order:1});t.json(r)}catch(e){console.log(e)}}))}getProducts(e,t){var n;return s(this,void 0,void 0,(function*(){try{const o=e.query.category,r=e.query.organization,i=e.query.searchQuery,s=e.body.username;if(!r)throw Error();const d=yield u.User.findOne({username:s}),c=yield u.Group.findOne({description:"HIDDEN",organization:r});let l={};o?"favorite"!==o&&(l={$and:[{"products.group":o||""},{"products.group":{$ne:c?c._id:""}}]}):l={"products.name":{$regex:i||"",$options:"i"},"products.group":{$ne:c?c._id:""}};const f=[{$match:{organization:r}},{$unwind:"$products"},{$match:l},{$lookup:{from:"favorites",let:{favId:"$products"},pipeline:[{$match:{user:d._id}},{$project:{products:{$setIntersection:["$$ROOT.products","$products"]}}}],as:"fav"}},{$addFields:{firstFromFav:{$first:"$fav.products"}}},{$addFields:{"products.isFav":{$cond:[{$in:["$products.id","$firstFromFav.id"]},!0,!1]}}},{$set:{fav:"$$REMOVE"}},{$group:{_id:null,products:{$push:"$$ROOT.products"}}}];"favorite"===o&&f.push({$project:{products:{$filter:{input:"$products",as:"product",cond:{$eq:["$$product.isFav",!0]}}}}});const p=yield a.Product.aggregate(f),h=yield null===(n=a.StopList.findOne({organization:r}))||void 0===n?void 0:n.products,y=p[0]?p[0].products.filter((e=>h?!h.find((t=>t.productId===e.id&&0===t.balance)):e)):[];t.status(200).json(y)}catch(e){console.log(e),t.status(400).json("Bad request")}}))}getProduct(e,t){return s(this,void 0,void 0,(function*(){try{const{id:n}=e.params,{username:o}=e.body,r=yield u.User.findOne({username:o});if(!r)throw Error();const i=r.organization;let s=yield a.Product.aggregate([{$match:{organization:i}},{$unwind:"$products"},{$match:{"products.id":n}},{$lookup:{from:"favorites",pipeline:[{$match:{user:r._id}},{$unwind:"$products"},{$group:{_id:null,products:{$addToSet:"$products.id"}}},{$unset:"_id"}],as:"fav"}},{$addFields:{firstFromFav:{$cond:[{$eq:[{$size:"$fav"},0]},[],{$first:"$fav"}]}}},{$addFields:{"products.isFav":{$cond:[{$in:["$$ROOT.products.id","$firstFromFav.products"]},!0,!1]}}},{$project:{products:1}}]);s=s[0].products;const d=yield a.StopList.findOne({organization:i,"products.productId":s.id});if(!s||d)throw Error();const c=yield a.Group.findOne({_id:s.group});let l=null;s.code.match(/^SO-\d+$/)||(l=yield a.Product.aggregate([{$unwind:"$products"},{$match:{organization:r.organization,"products.code":{$regex:/^SO-\d+$/}}},{$project:{organization:0,revision:0,_id:0}},{$group:{_id:null,sauces:{$addToSet:"$products"}}}]),l.length&&(l=l[0].sauces)),t.json({group:c,sauces:l,product:s})}catch(e){return console.log(e),t.status(404).json("Not found")}}))}}},494:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=r(n(185)),s=r(n(344)),a=n(45),u=r(n(792)),d=r(n(354));t.default=class{login(e,t){return o(this,void 0,void 0,(function*(){try{const{username:n,tokens:o}=e.body;yield a.User.updateOne({username:n},{refreshToken:o.refresh}),t.cookie("refresh",o.refresh,{maxAge:2592e6,httpOnly:!0}),t.status(200).json({isAuth:!0,access:o.access})}catch(e){console.log(e),t.status(401).json("Not authhorized, \n"+(null==e?void 0:e.message))}}))}register(e,t){var n,r;return o(this,void 0,void 0,(function*(){try{const{organization:o}=e.body;let d=e.headers.authorization;d=d&&d.split(" ")[1];const c=null===(r=null===(n=s.default.decode(d,{complete:!0}))||void 0===n?void 0:n.payload)||void 0===r?void 0:r.username;if(yield a.User.findOne({username:c}))return t.status(200).json({isNew:!1});const{access:l,refresh:f,username:p}=(0,u.default)(),h=new i.default.Types.ObjectId,y=new i.default.Types.ObjectId,g=new i.default.Types.ObjectId;yield a.Cart.create({_id:y,user:h,products:[]}),yield a.Order.create({user:h,orders:[]}),yield a.Favorite.create({_id:g,user:h,products:[]}),yield a.User.create({_id:h,refreshToken:f,cart:y,favorite:g,organization:o,username:p}),t.cookie("refresh",f,{maxAge:2592e6,httpOnly:!0}),t.status(200).json({isNew:!0,access:l})}catch(e){console.log(e),t.status(500).json("Server error")}}))}updateProfile(e,t){return o(this,void 0,void 0,(function*(){const{username:n,phone:o,email:r,organization:i,name:s}=e.body;try{const e=yield a.User.findOneAndUpdate({username:n},{name:s,phone:o,email:r,organization:i},{fields:{token:0,cart:0,organization:0}});t.status(200).json({message:"ok",user:e})}catch(e){console.log(e),t.status(500).json("Server error")}}))}getProfile(e,t){return o(this,void 0,void 0,(function*(){const n=e.body.username;try{const e=yield a.User.findOne({username:n},{token:0,_id:0}).populate({path:"organization",populate:{path:"city"}}).populate({path:"cart",populate:{path:"products.product"},select:{user:0,_id:0}});if(!e.organization)return t.status(200).json({isAuth:!1,user:e});const o=yield(0,d.default)(e.cart.products,e.organization._id);t.status(200).json({isAuth:!0,user:Object.assign(Object.assign({},e._doc),{cart:{totalPrice:e.cart.totalPrice,products:o}})})}catch(e){console.log(e),t.status(500).json("Server error")}}))}}},978:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(45),s=r(n(992)),a=r(n(354)),u=r(n(215)),d=r(n(829)),c=n(64),l=r(n(90)),f=r(n(610));t.default=class{addToCart(e,t){return o(this,void 0,void 0,(function*(){const{product:n,username:o}=e.body;try{const e=yield i.User.findOne({username:o});if(!e)throw Error("Bad request");if(!(yield i.Product.findOne({organization:e.organization,"products.id":n})))throw Error("Bad request");let r=yield i.Cart.findOne({_id:e.cart});const s=r.products.find((e=>e.product===n));r=s?yield i.Cart.findOneAndUpdate({_id:e.cart,"products.product":n},{$inc:{"products.$.amount":1}},{new:!0}):yield i.Cart.findOneAndUpdate({_id:e.cart},{$push:{products:{product:n}}},{new:!0});const d=yield(0,a.default)(r.products,e.organization),c=yield(0,u.default)(d,r._id);t.status(200).json({products:d,totalPrice:c})}catch(e){console.log(e),t.status(400).json("Bad request")}}))}addToFavorite(e,t){return o(this,void 0,void 0,(function*(){try{const{username:n,productId:o}=e.body,r=yield i.User.findOne({username:n}),s=yield i.Product.aggregate([{$unwind:"$products"},{$match:{organization:r.organization,"products.id":o}},{$project:{products:1}}]);if(!s.length)throw Error("Product not found");console.log(s[0]);const a=yield l.default.findOne({user:r._id,"products.id":o});let u={};const d={isActive:!1};a?(u={$pull:{products:{id:o}}},d.isActive=!1):(u={$push:{products:s[0].products}},d.isActive=!0),yield l.default.updateOne({user:r._id},u),t.status(200).json(Object.assign({message:"success"},d))}catch(e){console.log(e),t.status(400).json("Bad request")}}))}removeOne(e,t){return o(this,void 0,void 0,(function*(){const{username:n,cart:o}=e.body;try{const e=yield i.User.findOne({username:n}),r=yield i.Cart.findOneAndUpdate({_id:e.cart,"products._id":o},{$pull:{products:{_id:o}}},{new:!0}),s=yield(0,a.default)(r.products,e.organization),d=yield(0,u.default)(s,o._id);t.status(200).json({products:s,totalPrice:d})}catch(e){console.log(e),t.status(400).json("Bad request")}}))}clear(e,t){return o(this,void 0,void 0,(function*(){const n=e.body.username;try{const e=yield i.User.findOne({username:n});if(yield i.Cart.findOneAndUpdate({_id:e.cart},{$set:{products:[]}},{new:!0}),!e)throw Error();t.status(200).json({products:[],totalPrice:0})}catch(e){console.log(e),t.status(400).json("Bad request")}}))}changeAmount(e,t){return o(this,void 0,void 0,(function*(){try{const n=e.body.type,{cart:o,username:r,count:s}=e.body;let d={};const c=yield i.User.findOne({username:r});switch(n){case"inc":d=1;break;case"dec":d=-1;break;default:throw Error("Bad request")}let l=yield i.Cart.findOne({_id:c.cart,"products._id":o});const f=s;console.log(s),l=yield i.Cart.findOneAndUpdate({_id:c.cart,"products._id":o},{$set:{"products.$.amount":f}},{new:!0});const p=yield(0,a.default)(l.products,c.organization),h=yield(0,u.default)(p,o._id);t.status(200).json({products:p,totalPrice:h})}catch(e){console.log(e),t.status(400).json("Bad request")}}))}getCart(e,t){return o(this,void 0,void 0,(function*(){const n=e.body.username;try{const e=yield i.User.findOne({username:n}),o=yield i.Cart.findOne({_id:e.cart}),r=yield(0,a.default)(o.products,e.organization),s=yield(0,u.default)(r,o._id);t.status(200).json({products:r,totalPrice:s})}catch(e){console.log(e),t.status(400).json("Bad request")}}))}createOrder(e,t){return o(this,void 0,void 0,(function*(){const{username:n,address:o,comment:r,phone:u,date:l,promocode:p,cart_choice:h,name:y,payment:g,times:v,notCall:_}=e.body;try{const e=yield i.User.findOne({username:n});if(!e)throw Error();const h=yield(0,c.separateAddress)(o);if(200!==h.status)return t.status(h.status).json(h.message);const g=yield i.Cart.findOne({_id:e.cart}),_=yield(0,a.default)(g.products,e.organization),m=yield(0,f.default)(_);if(Object.keys(m).length>0)return t.status(200).json({success:!1,errors:m});const{locality:O,street:b,house:j}=h.separateAddressObject,$=(0,s.default)({locality:O,street:b,house:j},e.organization,{name:y,comment:r,date:l,phone:u,times:v,promocode:p},_),{status:w,message:P}=yield d.default.iikoMethodBuilder((()=>d.default.createOrder($)));if(console.log(w),200!==w)return t.status(w).json({status:!1,message:P});yield i.Cart.updateOne({_id:e.cart},{$set:{products:[],totalPrice:0}},{new:!1}),yield i.Order.findOneAndUpdate({user:e._id},{$push:{orders:{products:g.products,totalPrice:g.totalPrice}}});const S=yield i.Order.aggregate([{$project:{orders:1}},{$unwind:"$orders"},{$group:{_id:null,count:{$sum:1}}}]);yield i.User.updateOne({username:n},{isVerify:!0,phone:u,name:y}),t.status(200).json({success:!0,orderNumber:S[0].count})}catch(e){console.log(e),t.status(404).json({success:!1,messsage:e})}}))}}},915:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=r(n(185));t.default=function(){return o(this,void 0,void 0,(function*(){yield i.default.connect(process.env.mongo_connect_url),console.log("success connect to mongo deliverycx")}))}},72:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=n(185),r=new o.Schema({_id:{required:!0,type:String},name:{required:!0,type:String}},{versionKey:!1});t.default=(0,o.model)("Category",r)},453:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=n(185),r=new o.Schema({classifierId:{required:!0,type:String},additionalInfo:{required:!0,type:String},externalRevision:{required:!0,type:Number},name:{required:!0,type:String}},{versionKey:!1});t.default=(0,o.model)("City",r)},861:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=n(185),r=new o.Schema({_id:{required:!0,type:String},name:{required:!0,type:String},description:{type:String},code:{required:!0,type:String},order:{required:!0,type:Number},image:{required:!0,type:String},organization:{required:!0,type:String,ref:"Organization"},isIncludedInMenu:{required:!0,type:Boolean}},{versionKey:!1});t.default=(0,o.model)("Group",r)},190:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(185)),a=new s.Schema({_id:{required:!0,type:String},city:{required:!0,type:s.default.Types.ObjectId,ref:"City"},longitude:{required:!0,type:Number},latitude:{required:!0,type:Number},street:{required:!0,type:String},contacts:{phone:{required:!0,type:String},email:String},products:{required:!0,type:s.default.Types.ObjectId,ref:"product"}},{versionKey:!1});t.default=(0,s.model)("Organization",a)},169:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ProductSchema=void 0;const o=n(185);t.ProductSchema=new o.Schema({id:String,name:{required:!0,type:String},code:{required:!0,type:String},price:{required:!0,type:Number},image:{required:!0,type:String},isIncludedInMenu:{required:!0,type:Boolean},order:Number,group:{required:!0,type:String,ref:"Group"},category:{required:!0,type:String,ref:"Category"},weight:{required:!0,type:Number},measureUnit:{required:!0,type:String},description:{required:!0,type:String},additionalInfo:{required:!0,type:String}});const r=new o.Schema({organization:{ref:"organization",type:String},products:[t.ProductSchema],revision:Number},{versionKey:!1});t.default=(0,o.model)("Products",r)},743:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=n(185),r=new o.Schema({organization:{type:String,ref:"Organization"},products:[{productId:String,balance:Number}]},{versionKey:!1});t.default=(0,o.model)("StopList",r)},45:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Order=t.Cart=t.User=t.Product=t.Organization=t.Group=t.City=t.StopList=t.Favorite=t.Category=void 0;const r=o(n(72));t.Category=r.default;const i=o(n(453));t.City=i.default;const s=o(n(861));t.Group=s.default;const a=o(n(190));t.Organization=a.default;const u=o(n(169));t.Product=u.default;const d=o(n(743));t.StopList=d.default;const c=o(n(726));t.Cart=c.default;const l=o(n(993));t.Order=l.default;const f=o(n(90));t.Favorite=f.default;const p=o(n(983));t.User=p.default},983:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(185)),a=new s.Schema({refreshToken:{required:!0,type:String},favorite:{ref:"Favorite",type:s.default.Types.ObjectId},cart:{ref:"Cart",type:s.default.Types.ObjectId},username:String,name:{required:!1,type:String},phone:{required:!1,type:String},isVerify:{required:!0,type:Boolean,default:!1},organization:{type:String,ref:"Organization"},orderHistory:{type:s.default.Types.ObjectId,ref:"Order"}},{versionKey:!1});t.default=(0,s.model)("User",a)},726:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.CartSchema=void 0;const s=i(n(185));t.CartSchema=new s.Schema({user:{required:!0,ref:"User",type:s.default.Types.ObjectId},products:[{product:String,amount:{type:Number,default:1,min:1}}],totalPrice:{required:!0,default:0,type:Number}},{versionKey:!1});const a=(0,s.model)("Cart",t.CartSchema);t.default=a},90:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(185)),a=n(169),u=new s.Schema({user:{ref:"User",type:s.default.Types.ObjectId},products:[a.ProductSchema]},{versionKey:!1});t.default=(0,s.model)("Favorite",u)},993:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=n(185),r=new o.Schema({user:{type:o.Types.ObjectId,ref:"User"},orders:[{products:[{product:{type:String,ref:"Products"},amount:Number}],date:{type:Date,default:Date.now},totalPrice:Number}]},{versionKey:!1}),i=(0,o.model)("Order",r);t.default=i},992:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(n(245));t.default=function(e,t,n,o){try{const{phone:i,name:s,comment:a}=n;return{organization:t,customer:{name:s,phone:i},order:{date:(0,r.default)().format("YYYY-MM-DD HH:mm:ss"),phone:i,isSelfService:"false",items:o.map((e=>({id:e.product.id,name:e.product.name,amount:e.amount,code:e.product.code,sum:e.product.price}))),address:{city:e.locality,street:e.street.split(" ")[1],home:e.house,comment:a}}}}catch(e){return console.log(e),{}}}},792:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(n(344));t.default=function(e=null){let t;return t=e||`u_${Math.random().toString(36).substr(2,9)}`,{access:r.default.sign({username:t},process.env.JWT_SECRET,{expiresIn:"7d"}),refresh:r.default.sign({username:t},process.env.JWT_SECRET,{expiresIn:"30d"}),username:t}}},64:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.separateAddress=t.geoCode=void 0;const i=r(n(167)),s=n(435);function a(e,t){var n;const o=(new s.DOMParser).parseFromString(e,"text/xml"),r=t.split(" ");let i=o.documentElement.getElementsByTagName(r[0])[0];if(i=null===(n=i.getElementsByTagName(r[1])[0].firstChild)||void 0===n?void 0:n.textContent,"string"==typeof i){const[e,t]=i.split(" ");return{longitude:+e,latitude:+t}}return null}t.geoCode=function(e){return o(this,void 0,void 0,(function*(){try{const t=encodeURI(e),n=yield i.default.get(`https://geocode-maps.yandex.ru/1.x/?apikey=${process.env.yandex_apiKey}&geocode=${t}`);return 200!==n.status?null:a(n.data,"Point pos")}catch(e){return console.log(e),null}}))},t.separateAddress=function(e){return o(this,void 0,void 0,(function*(){e=encodeURI(e);const{data:t,status:n}=yield i.default.get(`https://geocode-maps.yandex.ru/1.x/?geocode=${e}&format=json&apikey=${process.env.yandex_apiKey}`);if(console.log(t),200!==n)return{status:n,message:"Something went wrong"};if(0==+t.response.GeoObjectCollection.metaDataProperty.GeocoderResponseMetaData.found)return{status:400,message:"Не верно задан адрес"};const o={};return t.response.GeoObjectCollection.featureMember[0].GeoObject.metaDataProperty.GeocoderMetaData.Address.Components.forEach((e=>{o[e.kind]=e.name})),{status:200,message:"OK",separateAddressObject:o}}))},t.default=a},354:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=r(n(169));t.default=function(e,t){return o(this,void 0,void 0,(function*(){const n=[];for(let o in e){const r=e[o],s=yield i.default.aggregate([{$unwind:"$products"},{$match:{organization:t,"products.id":r.product}},{$project:{_id:0,organization:0}},{$group:{_id:null,product:{$addToSet:"$products"}}}]);s.length&&n.push({product:s[0].product[0],_id:r._id,amount:r.amount})}return n}))}},63:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.parseOrganization=void 0,t.parseOrganization=function(e){var t;const n=null===(t=e.address.match(/^(?<city>[а-я]+),\s?(?<address>[а-я0-9\s]+)$/i))||void 0===t?void 0:t.groups;return{id:e.id,address:{fulladdress:e.address,city:n?n.city.trim():null,address:n?n.address.trim():null},contacts:{phone:e.contact.phone,email:e.contact.email}}}},902:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),o(n(142)).default.config();const r=o(n(860)),i=o(n(986)),s=o(n(710)),a=o(n(582)),u=o(n(17)),d=o(n(915)),c=o(n(829)),l=o(n(707)),f=o(n(370)),p=o(n(574)),h=o(n(753)),y=u.default.resolve(__dirname,"../../client/build/index.html"),g=(0,r.default)(),v=process.env.PORT||5001;g.use(r.default.static(u.default.resolve(__dirname,"../../client/build"))),g.use((0,a.default)({credentials:!0,origin:process.env.CLIENT_URL})),g.use((0,i.default)()),g.use((0,s.default)()),g.use("/api",l.default),g.use("/profile",p.default),g.use("/shop",h.default,f.default),g.get("/*",((e,t)=>{t.sendFile(y)})),g.listen(v,(()=>{try{console.log(`starting on ${v}`),(0,d.default)().then((()=>{c.default.pooling(),setInterval((()=>{c.default.pooling()}),216e5),setInterval((()=>{c.default.iikoMethodBuilder(c.default.getStopLists)}),6e5)})).catch((e=>console.log(e)))}catch(e){console.log(e)}}))},753:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t},s=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const u=i(n(344)),d=a(n(792));t.default=function(e,t,n){return s(this,void 0,void 0,(function*(){const o=e.headers.authorization;if(!o)return t.status(401).json({isAuth:!1});try{const t=o.split(" ")[1];u.default.verify(t,process.env.JWT_SECRET,((o,r)=>s(this,void 0,void 0,(function*(){var i,s;if(o){if(!(o instanceof u.TokenExpiredError))throw Error();{const o=yield null===(s=null===(i=u.default.decode(t,{complete:!0}))||void 0===i?void 0:i.payload)||void 0===s?void 0:s.username,r=e.cookies.refresh;yield u.default.verify(r,process.env.JWT_SECRET);const{access:a,refresh:c}=(0,d.default)(o);e.body.username=o,e.body.tokens={access:a,refresh:c},n()}}else{const t=null==r?void 0:r.username,{access:o,refresh:i}=(0,d.default)(t);e.body.username=t,e.body.tokens={access:o,refresh:i},n()}}))))}catch(e){console.log(e),t.status(401).json({isAuth:!1})}}))}},707:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(n(860)),i=o(n(753)),s=r.default.Router(),a=new(o(n(493)).default);s.get("/getCities",a.getCities),s.get("/getAddresses",a.getAddresses),s.get("/getCategories",i.default,a.getCategories),s.get("/getProducts",i.default,a.getProducts),s.get("/getProduct/:id",i.default,a.getProduct),t.default=s},574:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(n(860)),i=o(n(494)),s=o(n(753)),a=r.default.Router(),u=new i.default;a.post("/login",s.default,u.login.bind(u)),a.post("/register",u.register.bind(u)),a.post("/getProfile",s.default,u.getProfile.bind(u)),a.post("/update",s.default,u.updateProfile.bind(u)),t.default=a},370:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(n(860)).default.Router(),i=new(o(n(978)).default);r.post("/addToCart",i.addToCart),r.post("/addToFavorite",i.addToFavorite),r.post("/createOrder",i.createOrder),r.get("/getCart",i.getCart),r.patch("/changeAmount",i.changeAmount),r.delete("/remove",i.removeOne),r.delete("/clear",i.clear),t.default=r},829:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t},s=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const u=a(n(167)),d=n(63),c=i(n(45)),l=n(64),f=a(n(504));class p{constructor(){this.organizations=[]}iikoMethodBuilder(e){return s(this,void 0,void 0,(function*(){return yield this.getToken(),yield e()}))}static getInstance(){return p._instance||(p._instance=new p),p._instance}get token(){return p.token}getToken(){return s(this,void 0,void 0,(function*(){try{const e=yield u.default.get(`https://iiko.biz:9900/api/0/auth/access_token?user_id=${process.env.iiko_user}&user_secret=${process.env.iiko_password}`);p.token=e.data}catch(e){console.log(`Error with get token\n${e}`)}}))}getOrganizations(){return s(this,void 0,void 0,(function*(){try{console.log("starting get organizations");const e=yield u.default.get(`https://iiko.biz:9900/api/0/organization/list?access_token=${p.token}`);this.organizations=e.data.map((e=>(0,d.parseOrganization)(e)))}catch(e){console.log(`Error with get organizations\n${e}`)}}))}createOrder(e){return s(this,void 0,void 0,(function*(){try{const{data:t}=yield u.default.post(`https://iiko.biz:9900/api/0/orders/checkCreate?access_token=${p.token}`,e);if(0!==t.resultState)return{status:400,message:t.problem};const{data:n}=yield u.default.post(`https://iiko.biz:9900/api/0/orders/add?access_token=${p.token}`,e);return{status:200,message:n}}catch(e){return{status:e.response.data.httpStatusCode,message:e.response.data.description}}}))}getAndSaveNomenclature(){return s(this,void 0,void 0,(function*(){try{for(let e in this.organizations){const t=yield u.default.get(`https://iiko.biz:9900/api/0/nomenclature/${this.organizations[e].id}?access_token=${p.token}`),n=this.organizations[e],o={products:t.data.products,groups:t.data.groups,categories:t.data.productCategories,revision:t.data.revision},r=yield c.City.findOneAndUpdate({name:n.address.city},{$setOnInsert:{name:n.address.city}},{new:!0,upsert:!0});yield Promise.all(o.categories.map((e=>s(this,void 0,void 0,(function*(){yield c.Category.findOneAndUpdate({_id:e.id},Object.assign(Object.assign({},e),{_id:e.id}),{upsert:!0})}))))),yield c.Group.deleteMany({organization:n.id}),yield Promise.all(o.groups.map((e=>s(this,void 0,void 0,(function*(){var t;e.parentGroup&&(yield c.Group.findOneAndUpdate({_id:e.id},Object.assign(Object.assign({},e),{image:e.images.length?null===(t=e.images[e.images.length-1])||void 0===t?void 0:t.imageUrl:"",organization:n.id,_id:e.id}),{upsert:!0}))})))));const i=yield Promise.all(o.products.map((e=>s(this,void 0,void 0,(function*(){var t;const n=yield(0,f.default)(e.images.length?null===(t=e.images[e.images.length-1])||void 0===t?void 0:t.imageUrl:"");return Object.assign(Object.assign({},e),{image:n,category:e.productCategoryId,group:e.parentGroup})}))))),a=yield c.Product.findOneAndUpdate({organization:n.id},{$setOnInsert:{organization:n.id},revision:o.revision,$set:{products:i}},{new:!0,upsert:!0}),d=yield(0,l.geoCode)(n.address.fulladdress);yield c.Organization.findOneAndUpdate({_id:n.id},{$setOnInsert:{_id:n.id,city:r._id,street:n.address.address,longitude:null==d?void 0:d.longitude,latitude:null==d?void 0:d.latitude,products:a._id},$set:{contacts:Object.assign({},n.contacts)}},{new:!0,upsert:!0})}}catch(e){console.log(`Error with get products\n${e}`)}}))}getStopLists(e=""){return s(this,void 0,void 0,(function*(){try{(yield c.Organization.find({})).forEach((e=>{console.log(`Starting get stopLists for organization: ${e._id}`),u.default.get(`https://iiko.biz:9900/api/0/stopLists/getDeliveryStopList?access_token=${p.token}&organization=${e._id}`).then((({data:{stopList:t}})=>s(this,void 0,void 0,(function*(){const n=t.map((e=>e.items));yield c.StopList.findOneAndUpdate({organization:e._id},{$setOnInsert:{organization:e._id},$set:{products:n}},{upsert:!0}),console.log(`End get stopLists for organization: ${e._id}`)})))).catch((t=>{console.log(`Error in stop lists ${e._id}\n${t}`)}))}))}catch(e){return console.log(e),[]}}))}pooling(){return s(this,void 0,void 0,(function*(){console.log("start pooling"),yield this.getToken(),yield this.getOrganizations(),yield this.getAndSaveNomenclature(),console.log("end pooling")}))}}p.token="",t.default=p.getInstance()},215:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=r(n(726));t.default=function(e,t){return o(this,void 0,void 0,(function*(){const n=e.reduce(((e,t)=>e+t.amount*t.product.price),0);return yield i.default.updateOne({_id:t},{totalPrice:n}),n}))}},610:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=r(n(147)),s=r(n(17));t.default=function(e){return o(this,void 0,void 0,(function*(){const t=JSON.parse(i.default.readFileSync(s.default.resolve(__dirname,"./validationSchema.json"),{encoding:"utf-8"}));let n={};return e.forEach((o=>{const r=o.product.group,i=t.find((e=>e.product_code===r));if(i)if(!0===i.total_amount){const t=e.filter((e=>e.product.group===r)).reduce(((e,t)=>e+t.amount),0);(t<i.min_amount||t>i.max_amount)&&(n[r]={message:`Заказ на доставку от ${i.min_amount} шт. Пожалуйста добавьте еще.`})}else(o.amount<i.min_amount||o.amount>i.max_amount)&&(n[r]={message:`Заказ на доставку от ${i.min_amount} шт. Пожалуйста добавьте еще.`})})),n}))}},504:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t},s=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.clearDir=void 0;const u=i(n(147)),d=i(n(12)),c=i(n(17)),l=i(n(828)),f=a(n(227));t.clearDir=function(){return s(this,void 0,void 0,(function*(){u.readdir("../static",((e,t)=>{if(e)throw e;for(const e of t)u.unlink(c.join("../static",e),(e=>{if(e)throw e}))}))}))},t.default=function(e){return s(this,void 0,void 0,(function*(){if(""===e)return"";const t=yield d.read(e),n=t._originalMime.split("/")[1],o=`${l.v4()}_${Date.now()}.${n}`;return yield t.resize(300,d.AUTO),yield t.writeAsync(`${f.default.get()}/static/${o}`),`/static/${o}`}))}},227:e=>{e.exports=require("app-root-dir")},167:e=>{e.exports=require("axios")},986:e=>{e.exports=require("body-parser")},710:e=>{e.exports=require("cookie-parser")},582:e=>{e.exports=require("cors")},142:e=>{e.exports=require("dotenv")},860:e=>{e.exports=require("express")},12:e=>{e.exports=require("jimp")},344:e=>{e.exports=require("jsonwebtoken")},245:e=>{e.exports=require("moment")},185:e=>{e.exports=require("mongoose")},828:e=>{e.exports=require("uuid")},435:e=>{e.exports=require("xmldom")},147:e=>{e.exports=require("fs")},17:e=>{e.exports=require("path")}},t={};!function n(o){var r=t[o];if(void 0!==r)return r.exports;var i=t[o]={exports:{}};return e[o].call(i.exports,i,i.exports,n),i.exports}(902)})();