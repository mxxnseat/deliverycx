(()=>{"use strict";var e={493:function(e,t,r){var o=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&o(t,e,r);return n(t,e),t},u=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function u(e){try{s(o.next(e))}catch(e){i(e)}}function a(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((o=o.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(r(45)),d=r(45),c=r(169),l=a(r(829));t.default=class{getCities(e,t){return u(this,void 0,void 0,(function*(){try{const r=e.query.city,o=yield s.City.find({name:{$regex:r,$options:"i"}});t.json(o)}catch(e){console.log(e)}}))}getAddresses(e,t){return u(this,void 0,void 0,(function*(){const r=e.query.city;if(!r)return t.status(400).json("Bad request");try{const e=yield s.Organization.find({city:r}).populate("city");t.json(e)}catch(e){console.log(e)}}))}getCategories(e,t){return u(this,void 0,void 0,(function*(){try{const{username:r}=e.body,o=yield d.User.findOne({username:r}),n=yield s.Group.find({organization:o.organization,description:{$ne:"HIDDEN"}}).sort({order:1});t.json(n)}catch(e){console.log(e)}}))}getProducts(e,t){var r;return u(this,void 0,void 0,(function*(){try{const o=e.query.category,n=e.query.organization,i=e.query.searchQuery,u=e.body.username;if(!n)throw Error();const a=yield d.User.findOne({username:u}),f=yield d.Group.findOne({description:"HIDDEN",organization:n});let p={};o?"favorite"!==o&&(p={$and:[{"products.group":o||""},{"products.group":{$ne:f?f._id:""}}]}):p={"products.name":{$regex:i||"",$options:"i"},"products.group":{$ne:f?f._id:""}};const y=[{$match:{organization:n}},{$unwind:"$products"},{$match:p},{$lookup:{from:"favorites",let:{favId:"$products"},pipeline:[{$match:{user:a._id}},{$project:{products:{$setIntersection:["$$ROOT.products","$products"]}}}],as:"fav"}},{$addFields:{firstFromFav:{$first:"$fav.products"}}},{$addFields:{"products.isFav":{$cond:[{$in:["$products.id","$firstFromFav.id"]},!0,!1]}}},{$set:{fav:"$$REMOVE"}},{$group:{_id:null,products:{$push:"$$ROOT.products"}}}];"favorite"===o&&y.push({$project:{products:{$filter:{input:"$products",as:"product",cond:{$eq:["$$product.isFav",!0]}}}}});let h=yield s.Product.aggregate(y);const _=yield l.default.iikoMethodBuilder((()=>l.default.getStopList(n)));h=h[0]&&(null===(r=h[0].products)||void 0===r?void 0:r.map((e=>new c.ProductModel(e)))),h=h&&(yield s.Product.populate(h,{path:"group",select:{image:1,_id:0}}));const m=h?h.filter((e=>!(_&&_.find((t=>t.productId===e.id&&0===t.balance)))&&e)):[];t.status(200).json(m)}catch(e){console.log(e),t.status(400).json("Bad request")}}))}getProduct(e,t){var r;return u(this,void 0,void 0,(function*(){try{const{id:o}=e.params,{username:n}=e.body,i=yield d.User.findOne({username:n});if(!i)throw Error();const u=i.organization;let a=yield s.Product.aggregate([{$match:{organization:u}},{$unwind:"$products"},{$match:{"products.id":o}},{$lookup:{from:"favorites",pipeline:[{$match:{user:i._id}},{$unwind:"$products"},{$group:{_id:null,products:{$addToSet:"$products.id"}}},{$unset:"_id"}],as:"fav"}},{$addFields:{firstFromFav:{$cond:[{$eq:[{$size:"$fav"},0]},[],{$first:"$fav"}]}}},{$addFields:{"products.isFav":{$cond:[{$in:["$$ROOT.products.id","$firstFromFav.products"]},!0,!1]}}},{$project:{products:1}}]);a=a[0].products;const l=yield s.StopList.findOne({organization:u,"products.productId":a.id});if(!a||l)throw Error();const f=yield s.Group.findOne({_id:a.group});let p=null;a.code.match(/^SO-\d+$/)||(p=yield s.Product.aggregate([{$unwind:"$products"},{$match:{organization:i.organization,"products.code":{$regex:/^SO-\d+$/}}},{$project:{organization:0,revision:0,_id:0}},{$group:{_id:null,sauces:{$addToSet:"$products"}}}]),p.length&&(p=p[0]&&(null===(r=p[0].sauces)||void 0===r?void 0:r.map((e=>new c.ProductModel(e)))),p=p&&(yield s.Product.populate(p,{path:"group",select:{image:1,_id:0}})))),t.json({group:f,sauces:p,product:a})}catch(e){return console.log(e),t.status(404).json("Not found")}}))}}},494:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function u(e){try{s(o.next(e))}catch(e){i(e)}}function a(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((o=o.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(r(185)),u=n(r(344)),a=r(45),s=n(r(792)),d=n(r(354));t.default=class{login(e,t){return o(this,void 0,void 0,(function*(){try{const{username:r,tokens:o}=e.body;yield a.User.updateOne({username:r},{refreshToken:o.refresh}),t.cookie("refresh",o.refresh,{maxAge:2592e6,httpOnly:!0}),t.status(200).json({isAuth:!0,access:o.access})}catch(e){console.log(e),t.status(401).json("Not authhorized, \n"+(null==e?void 0:e.message))}}))}register(e,t){var r,n;return o(this,void 0,void 0,(function*(){try{const{organization:o}=e.body;let d=e.headers.authorization;d=d&&d.split(" ")[1];const c=null===(n=null===(r=u.default.decode(d,{complete:!0}))||void 0===r?void 0:r.payload)||void 0===n?void 0:n.username;if(yield a.User.findOne({username:c}))return t.status(200).json({isNew:!1});const{access:l,refresh:f,username:p}=(0,s.default)(),y=new i.default.Types.ObjectId,h=new i.default.Types.ObjectId,_=new i.default.Types.ObjectId;yield a.Cart.create({_id:h,user:y,products:[]}),yield a.Order.create({user:y,orders:[]}),yield a.Favorite.create({_id:_,user:y,products:[]}),yield a.User.create({_id:y,refreshToken:f,cart:h,favorite:_,organization:o,username:p}),t.cookie("refresh",f,{maxAge:2592e6,httpOnly:!0}),t.status(200).json({isNew:!0,access:l})}catch(e){console.log(e),t.status(500).json("Server error")}}))}updateProfile(e,t){return o(this,void 0,void 0,(function*(){const{username:r,phone:o,email:n,organization:i,name:u}=e.body;try{const e=yield a.User.findOneAndUpdate({username:r},{name:u,phone:o,email:n,organization:i},{fields:{token:0,cart:0,organization:0}});t.status(200).json({message:"ok",user:e})}catch(e){console.log(e),t.status(500).json("Server error")}}))}getProfile(e,t){return o(this,void 0,void 0,(function*(){const r=e.body.username;try{const e=yield a.User.findOne({username:r},{token:0,_id:0}).populate({path:"organization",populate:{path:"city"}}).populate({path:"cart",populate:{path:"products.product"},select:{user:0,_id:0}});if(!e.organization)return t.status(200).json({isAuth:!1,user:e});const o=yield(0,d.default)(e.cart.products,e.organization._id);t.status(200).json({isAuth:!0,user:Object.assign(Object.assign({},e._doc),{cart:{totalPrice:e.cart.totalPrice,products:o}})})}catch(e){console.log(e),t.status(500).json("Server error")}}))}}},978:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function u(e){try{s(o.next(e))}catch(e){i(e)}}function a(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((o=o.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=r(45),u=n(r(992)),a=n(r(354)),s=n(r(215)),d=n(r(829)),c=n(r(90)),l=n(r(610));t.default=class{addToCart(e,t){return o(this,void 0,void 0,(function*(){const{product:r,username:o}=e.body;try{const e=yield i.User.findOne({username:o});if(!e)throw Error("Bad request");if(!(yield i.Product.findOne({organization:e.organization,"products.id":r})))throw Error("Bad request");let n=yield i.Cart.findOne({_id:e.cart});const u=n.products.find((e=>e.product===r));n=u?yield i.Cart.findOneAndUpdate({_id:e.cart,"products.product":r},{$inc:{"products.$.amount":1}},{new:!0}):yield i.Cart.findOneAndUpdate({_id:e.cart},{$push:{products:{product:r}}},{new:!0});const d=yield(0,a.default)(n.products,e.organization),c=yield(0,s.default)(d,n._id);t.status(200).json({products:d,totalPrice:c})}catch(e){console.log(e),t.status(400).json("Bad request")}}))}addToFavorite(e,t){return o(this,void 0,void 0,(function*(){try{const{username:r,productId:o}=e.body,n=yield i.User.findOne({username:r}),u=yield i.Product.aggregate([{$unwind:"$products"},{$match:{organization:n.organization,"products.id":o}},{$project:{products:1}}]);if(!u.length)throw Error("Product not found");console.log(u[0]);const a=yield c.default.findOne({user:n._id,"products.id":o});let s={};const d={isActive:!1};a?(s={$pull:{products:{id:o}}},d.isActive=!1):(s={$push:{products:u[0].products}},d.isActive=!0),yield c.default.updateOne({user:n._id},s),t.status(200).json(Object.assign({message:"success"},d))}catch(e){console.log(e),t.status(400).json("Bad request")}}))}removeOne(e,t){return o(this,void 0,void 0,(function*(){const{username:r,cart:o}=e.body;try{const e=yield i.User.findOne({username:r}),n=yield i.Cart.findOneAndUpdate({_id:e.cart,"products._id":o},{$pull:{products:{_id:o}}},{new:!0}),u=yield(0,a.default)(n.products,e.organization),d=yield(0,s.default)(u,o._id);t.status(200).json({products:u,totalPrice:d})}catch(e){console.log(e),t.status(400).json("Bad request")}}))}clear(e,t){return o(this,void 0,void 0,(function*(){const r=e.body.username;try{const e=yield i.User.findOne({username:r});if(yield i.Cart.findOneAndUpdate({_id:e.cart},{$set:{products:[]}},{new:!0}),!e)throw Error();t.status(200).json({products:[],totalPrice:0})}catch(e){console.log(e),t.status(400).json("Bad request")}}))}changeAmount(e,t){return o(this,void 0,void 0,(function*(){try{const r=e.body.type,{cart:o,username:n,count:u}=e.body;let d={};const c=yield i.User.findOne({username:n});switch(r){case"inc":d=1;break;case"dec":d=-1;break;default:throw Error("Bad request")}let l=yield i.Cart.findOne({_id:c.cart,"products._id":o});const f=u;console.log(u),l=yield i.Cart.findOneAndUpdate({_id:c.cart,"products._id":o},{$set:{"products.$.amount":f}},{new:!0});const p=yield(0,a.default)(l.products,c.organization),y=yield(0,s.default)(p,o._id);t.status(200).json({products:p,totalPrice:y})}catch(e){console.log(e),t.status(400).json("Bad request")}}))}getCart(e,t){return o(this,void 0,void 0,(function*(){const r=e.body.username;try{const e=yield i.User.findOne({username:r}),o=yield i.Cart.findOne({_id:e.cart}),n=yield(0,a.default)(o.products,e.organization),u=yield(0,s.default)(n,o._id);t.status(200).json({products:n,totalPrice:u})}catch(e){console.log(e),t.status(400).json("Bad request")}}))}createOrder(e,t){return o(this,void 0,void 0,(function*(){const{username:r,address:o,comment:n,phone:s,date:c,flat:f,floor:p,city:y,intercom:h,entrance:_,promocode:m,cart_choice:v,name:g,payment:O,times:b,notCall:j}=e.body;try{const e=yield i.User.findOne({username:r});if(!e)throw Error();const v=yield i.Cart.findOne({_id:e.cart}),O=yield(0,a.default)(v.products,e.organization),j=yield(0,l.default)(O);if(Object.keys(j).length>0)return t.status(400).json({success:!1,errors:j});const $=(0,u.default)({address:o,flat:f,floor:p,intercom:h,entrance:_,city:y},e.organization,{name:g,comment:n,date:c,phone:s,times:b,promocode:m},O);let{status:P,message:w,number:S}=yield d.default.iikoMethodBuilder((()=>d.default.createOrder($)));if(console.log(w),200!==P)return t.status(P).json({success:!1,errors:{500:{message:`Some error ${w}`}}});yield i.Cart.updateOne({_id:e.cart},{$set:{products:[],totalPrice:0}},{new:!1}),yield i.Order.findOneAndUpdate({user:e._id},{$push:{orders:{products:v.products,totalPrice:v.totalPrice}}}),yield i.User.updateOne({username:r},{isVerify:!0,phone:s,name:g}),t.status(200).json({success:!0,orderNumber:S})}catch(e){console.log(e),t.status(404).json({success:!1,messsage:e})}}))}}},915:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function u(e){try{s(o.next(e))}catch(e){i(e)}}function a(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((o=o.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(r(185));t.default=function(){return o(this,void 0,void 0,(function*(){yield i.default.connect(process.env.mongo_connect_url),console.log("success connect to mongo deliverycx")}))}},72:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=r(185),n=new o.Schema({_id:{required:!0,type:String},name:{required:!0,type:String}},{versionKey:!1});t.default=(0,o.model)("Category",n)},453:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=r(185),n=new o.Schema({classifierId:{required:!0,type:String},additionalInfo:{required:!0,type:String},externalRevision:{required:!0,type:Number},name:{required:!0,type:String}},{versionKey:!1});t.default=(0,o.model)("City",n)},861:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=r(185),n=new o.Schema({_id:{required:!0,type:String},name:{required:!0,type:String},description:{type:String},code:{required:!0,type:String},order:{required:!0,type:Number},image:{required:!0,type:String},organization:{required:!0,type:String,ref:"Organization"},isIncludedInMenu:{required:!0,type:Boolean}},{versionKey:!1});t.default=(0,o.model)("Group",n)},190:function(e,t,r){var o=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&o(t,e,r);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const u=i(r(185)),a=new u.Schema({_id:{required:!0,type:String},city:{required:!0,type:u.default.Types.ObjectId,ref:"City"},longitude:{required:!0,type:Number},latitude:{required:!0,type:Number},street:{required:!0,type:String},contacts:{phone:{required:!0,type:String},email:String},products:{required:!0,type:u.default.Types.ObjectId,ref:"product"},workTime:String},{versionKey:!1});t.default=(0,u.model)("Organization",a)},169:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ProductModel=t.ProductSchema=void 0;const o=r(185);t.ProductSchema=new o.Schema({id:String,name:{required:!0,type:String},code:{required:!0,type:String},price:{required:!0,type:Number},image:{required:!0,type:String},isIncludedInMenu:{required:!0,type:Boolean},order:Number,group:{required:!0,type:String,ref:"Group"},category:{required:!0,type:String,ref:"Category"},weight:{required:!0,type:Number},measureUnit:{required:!0,type:String},description:{required:!0,type:String},additionalInfo:{required:!0,type:String},isFav:{required:!1,type:Boolean}});const n=new o.Schema({organization:{ref:"organization",type:String},products:[t.ProductSchema],revision:Number},{versionKey:!1});t.ProductModel=(0,o.model)("product",t.ProductSchema),t.default=(0,o.model)("Products",n)},743:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=r(185),n=new o.Schema({organization:{type:String,ref:"Organization"},products:[{productId:String,balance:Number}]},{versionKey:!1});t.default=(0,o.model)("StopList",n)},45:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Order=t.Cart=t.User=t.Product=t.Organization=t.Group=t.City=t.StopList=t.Favorite=t.Category=void 0;const n=o(r(72));t.Category=n.default;const i=o(r(453));t.City=i.default;const u=o(r(861));t.Group=u.default;const a=o(r(190));t.Organization=a.default;const s=o(r(169));t.Product=s.default;const d=o(r(743));t.StopList=d.default;const c=o(r(726));t.Cart=c.default;const l=o(r(993));t.Order=l.default;const f=o(r(90));t.Favorite=f.default;const p=o(r(983));t.User=p.default},983:function(e,t,r){var o=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&o(t,e,r);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const u=i(r(185)),a=new u.Schema({refreshToken:{required:!0,type:String},favorite:{ref:"Favorite",type:u.default.Types.ObjectId},cart:{ref:"Cart",type:u.default.Types.ObjectId},username:String,name:{required:!1,type:String},phone:{required:!1,type:String},isVerify:{required:!0,type:Boolean,default:!1},organization:{type:String,ref:"Organization"},orderHistory:{type:u.default.Types.ObjectId,ref:"Order"}},{versionKey:!1});t.default=(0,u.model)("User",a)},726:function(e,t,r){var o=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&o(t,e,r);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.CartSchema=void 0;const u=i(r(185));t.CartSchema=new u.Schema({user:{required:!0,ref:"User",type:u.default.Types.ObjectId},products:[{product:String,amount:{type:Number,default:1,min:1}}],totalPrice:{required:!0,default:0,type:Number}},{versionKey:!1});const a=(0,u.model)("Cart",t.CartSchema);t.default=a},90:function(e,t,r){var o=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&o(t,e,r);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const u=i(r(185)),a=r(169),s=new u.Schema({user:{ref:"User",type:u.default.Types.ObjectId},products:[a.ProductSchema]},{versionKey:!1});t.default=(0,u.model)("Favorite",s)},993:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=r(185),n=new o.Schema({user:{type:o.Types.ObjectId,ref:"User"},orders:[{products:[{product:{type:String,ref:"Products"},amount:Number}],date:{type:Date,default:Date.now},totalPrice:Number}]},{versionKey:!1}),i=(0,o.model)("Order",n);t.default=i},992:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=o(r(362));t.default=function(e,t,r,o){try{const{phone:i,name:u,comment:a}=r,s=n.default.tz("Europe/Moscow").format("YYYY-MM-DD HH:mm:ss"),d=e.address.split(","),c=d[0];return{organization:t,customer:{name:u,phone:i},order:{date:s,phone:i,isSelfService:"false",items:o.map((e=>({id:e.product.id,name:e.product.name,amount:e.amount,code:e.product.code,sum:e.product.price}))),address:{city:e.city,street:c,home:d[1]?d[1]:0,apartment:e.flat?e.flat:"0",entrance:e.entrance?e.entrance:"0",doorphone:e.intercom?e.intercom:"0",floor:e.floor?e.floor:"0",comment:a}}}}catch(e){return console.log(e),{}}}},792:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=o(r(344));t.default=function(e=null){let t;return t=e||`u_${Math.random().toString(36).substr(2,9)}`,{access:n.default.sign({username:t},process.env.JWT_SECRET,{expiresIn:"7d"}),refresh:n.default.sign({username:t},process.env.JWT_SECRET,{expiresIn:"30d"}),username:t}}},354:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function u(e){try{s(o.next(e))}catch(e){i(e)}}function a(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((o=o.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(r(169));t.default=function(e,t){return o(this,void 0,void 0,(function*(){const r=[];for(let o in e){const n=e[o],u=yield i.default.aggregate([{$unwind:"$products"},{$match:{organization:t,"products.id":n.product}},{$project:{_id:0,organization:0}},{$group:{_id:null,product:{$addToSet:"$products"}}}]);u.length&&r.push({product:u[0].product[0],_id:n._id,amount:n.amount})}return r}))}},902:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),o(r(142)).default.config({path:__dirname+"/../.env"});const n=o(r(860)),i=o(r(986)),u=o(r(710)),a=o(r(582)),s=o(r(17)),d=o(r(915)),c=o(r(707)),l=o(r(370)),f=o(r(574)),p=o(r(753)),y=s.default.resolve(__dirname,"../../client/build/index.html"),h=(0,n.default)(),_=process.env.PORT||5001;h.use(n.default.static(s.default.resolve(__dirname,"../../client/build"))),h.use((0,a.default)({credentials:!0,origin:process.env.CLIENT_URL})),h.use((0,i.default)()),h.use((0,u.default)()),h.use("/api",c.default),h.use("/profile",f.default),h.use("/shop",p.default,l.default),h.get("/*",((e,t)=>{t.sendFile(y)})),(0,d.default)().then((()=>{h.listen(_,(()=>{try{console.log(`starting on ${_}`)}catch(e){console.log(e)}}))})).catch((e=>console.log(e)))},753:function(e,t,r){var o=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&o(t,e,r);return n(t,e),t},u=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function u(e){try{s(o.next(e))}catch(e){i(e)}}function a(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((o=o.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(r(344)),d=a(r(792));t.default=function(e,t,r){return u(this,void 0,void 0,(function*(){const o=e.headers.authorization;if(!o)return t.status(401).json({isAuth:!1});try{const t=o.split(" ")[1];s.default.verify(t,process.env.JWT_SECRET,((o,n)=>u(this,void 0,void 0,(function*(){var i,u;if(o){if(!(o instanceof s.TokenExpiredError))throw Error();{const o=yield null===(u=null===(i=s.default.decode(t,{complete:!0}))||void 0===i?void 0:i.payload)||void 0===u?void 0:u.username,n=e.cookies.refresh;yield s.default.verify(n,process.env.JWT_SECRET);const{access:a,refresh:c}=(0,d.default)(o);e.body.username=o,e.body.tokens={access:a,refresh:c},r()}}else{const t=null==n?void 0:n.username,{access:o,refresh:i}=(0,d.default)(t);e.body.username=t,e.body.tokens={access:o,refresh:i},r()}}))))}catch(e){console.log(e),t.status(401).json({isAuth:!1})}}))}},707:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=o(r(860)),i=o(r(753)),u=n.default.Router(),a=new(o(r(493)).default);u.get("/getCities",a.getCities),u.get("/getAddresses",a.getAddresses),u.get("/getCategories",i.default,a.getCategories),u.get("/getProducts",i.default,a.getProducts),u.get("/getProduct/:id",i.default,a.getProduct),t.default=u},574:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=o(r(860)),i=o(r(494)),u=o(r(753)),a=n.default.Router(),s=new i.default;a.post("/login",u.default,s.login.bind(s)),a.post("/register",s.register.bind(s)),a.post("/getProfile",u.default,s.getProfile.bind(s)),a.post("/update",u.default,s.updateProfile.bind(s)),t.default=a},370:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=o(r(860)).default.Router(),i=new(o(r(978)).default);n.post("/addToCart",i.addToCart),n.post("/addToFavorite",i.addToFavorite),n.post("/createOrder",i.createOrder),n.get("/getCart",i.getCart),n.patch("/changeAmount",i.changeAmount),n.delete("/remove",i.removeOne),n.delete("/clear",i.clear),t.default=n},829:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function u(e){try{s(o.next(e))}catch(e){i(e)}}function a(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((o=o.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(r(167));class u{constructor(){this.organizations=[]}iikoMethodBuilder(e){return o(this,void 0,void 0,(function*(){return yield this.getToken(),yield e()}))}static getInstance(){return u._instance||(u._instance=new u),u._instance}get token(){return u.token}getToken(){return o(this,void 0,void 0,(function*(){try{const e=yield i.default.get(`https://iiko.biz:9900/api/0/auth/access_token?user_id=${process.env.iiko_user}&user_secret=${process.env.iiko_password}`);u.token=e.data}catch(e){console.log(`Error with get token\n${e}`)}}))}createOrder(e){return o(this,void 0,void 0,(function*(){try{const{data:t}=yield i.default.post(`https://iiko.biz:9900/api/0/orders/checkCreate?access_token=${u.token}`,e);if(0!==t.resultState)return{status:400,message:t.problem};const{data:r}=yield i.default.post(`https://iiko.biz:9900/api/0/orders/add?access_token=${u.token}`,e);return{status:200,message:r,number:r.number}}catch(e){return{status:e.response.data.httpStatusCode,message:e.response.data.description}}}))}getStopList(e){return o(this,void 0,void 0,(function*(){try{const{data:t}=yield i.default.get(`https://iiko.biz:9900/api/0/stopLists/getDeliveryStopList?access_token=${u.token}&organization=${e}`);return t.stopList.map((e=>e.items)).flat()}catch(e){return console.log(e),[]}}))}}u.token="",t.default=u.getInstance()},215:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function u(e){try{s(o.next(e))}catch(e){i(e)}}function a(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((o=o.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(r(726));t.default=function(e,t){return o(this,void 0,void 0,(function*(){const r=e.reduce(((e,t)=>e+t.amount*t.product.price),0);return yield i.default.updateOne({_id:t},{totalPrice:r}),r}))}},610:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function u(e){try{s(o.next(e))}catch(e){i(e)}}function a(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((o=o.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(r(147)),u=n(r(17));t.default=function(e){return o(this,void 0,void 0,(function*(){const t=JSON.parse(i.default.readFileSync(u.default.resolve(__dirname,"./validationSchema.json"),{encoding:"utf-8"}));let r={};return e.forEach((o=>{const n=o.product.group,i=t.find((e=>o.product.code.toString().toUpperCase().includes(e.product_code)));if(i)if(!0===i.total_amount){const t=e.filter((e=>e.product.group===n)).reduce(((e,t)=>e+t.amount),0);(t<i.min_amount||t>i.max_amount)&&(r[n]={message:`Заказ на доставку от ${i.min_amount} шт. Пожалуйста добавьте еще.`})}else(o.amount<i.min_amount||o.amount>i.max_amount)&&(r[n]={message:`Заказ на доставку от ${i.min_amount} шт. Пожалуйста добавьте еще.`})})),r}))}},167:e=>{e.exports=require("axios")},986:e=>{e.exports=require("body-parser")},710:e=>{e.exports=require("cookie-parser")},582:e=>{e.exports=require("cors")},142:e=>{e.exports=require("dotenv")},860:e=>{e.exports=require("express")},344:e=>{e.exports=require("jsonwebtoken")},362:e=>{e.exports=require("moment-timezone")},185:e=>{e.exports=require("mongoose")},147:e=>{e.exports=require("fs")},17:e=>{e.exports=require("path")}},t={};!function r(o){var n=t[o];if(void 0!==n)return n.exports;var i=t[o]={exports:{}};return e[o].call(i.exports,i,i.exports,r),i.exports}(902)})();