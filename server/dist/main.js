(()=>{"use strict";var e={493:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(45)),u=n(45);t.default=class{getCities(e,t){return s(this,void 0,void 0,(function*(){try{const e=yield a.City.find({});t.json(e)}catch(e){console.log(e)}}))}getAddresses(e,t){return s(this,void 0,void 0,(function*(){const n=e.query.city;if(!n)return t.status(400).json("Bad request");try{const e=yield a.Organization.find({city:n}).populate("city");t.json(e)}catch(e){console.log(e)}}))}getCategories(e,t){return s(this,void 0,void 0,(function*(){try{const e=yield a.Group.find({}).sort({order:1});t.json(e)}catch(e){console.log(e)}}))}getProducts(e,t){return s(this,void 0,void 0,(function*(){try{const n=e.query.category,r=e.query.organization,o=e.query.searchQuery,i=e.body.username;if(!r)throw Error();const s=yield u.User.findOne({username:i});let d={};n?"favorite"!==n&&(d={"products.group":n||""}):d={"products.name":{$regex:o||"",$options:"i"}};const c=[{$match:{organization:r}},{$unwind:"$products"},{$match:d},{$lookup:{from:"favorites",let:{favId:"$products"},pipeline:[{$match:{user:s._id}},{$project:{products:{$setIntersection:["$$ROOT.products","$products"]}}}],as:"fav"}},{$addFields:{firstFromFav:{$first:"$fav.products"}}},{$addFields:{"products.isFav":{$cond:[{$in:["$products.id","$firstFromFav.id"]},!0,!1]}}},{$set:{fav:"$$REMOVE"}},{$group:{_id:null,products:{$push:"$$ROOT.products"}}}];"favorite"===n&&c.push({$project:{products:{$filter:{input:"$products",as:"product",cond:{$eq:["$$product.isFav",!0]}}}}});const l=yield a.Product.aggregate(c);t.status(200).json(l[0]?l[0].products:[])}catch(e){console.log(e),t.status(400).json("Bad request")}}))}getProduct(e,t){return s(this,void 0,void 0,(function*(){try{const{id:n}=e.params,{username:r}=e.body,o=yield u.User.findOne({username:r});if(!o)throw Error();let i=yield a.Product.aggregate([{$match:{organization:o.organization}},{$unwind:"$products"},{$match:{"products.id":n}},{$lookup:{from:"favorites",pipeline:[{$match:{user:o._id}},{$unwind:"$products"},{$group:{_id:null,products:{$addToSet:"$products.id"}}},{$unset:"_id"}],as:"fav"}},{$addFields:{firstFromFav:{$cond:[{$eq:[{$size:"$fav"},0]},[],{$first:"$fav"}]}}},{$addFields:{"products.isFav":{$cond:[{$in:["$$ROOT.products.id","$firstFromFav.products"]},!0,!1]}}},{$project:{products:1}}]);if(i=i[0].products,!i)throw Error();const s=yield a.Group.findOne({_id:i.group});let d=null;i.code.match(/^SO-\d+$/)||(d=yield a.Product.aggregate([{$unwind:"$products"},{$match:{organization:o.organization,"products.code":{$regex:/^SO-\d+$/}}},{$project:{organization:0,revision:0,_id:0}},{$group:{_id:null,sauces:{$addToSet:"$products"}}}]),d.length&&(d=d[0].sauces)),t.json({group:s,sauces:d,product:i})}catch(e){return console.log(e),t.status(404).json("Not found")}}))}}},494:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(185)),s=o(n(344)),a=n(45),u=o(n(792)),d=o(n(354));t.default=class{login(e,t){return r(this,void 0,void 0,(function*(){const n=e.headers.authorization;try{if(void 0===n)throw Error("Not have access token, auth failed");{const e=n.split(" ")[1];s.default.verify(e,process.env.JWT_SECRET,((n,o)=>r(this,void 0,void 0,(function*(){var o;const i=null===(o=s.default.decode(e,{complete:!0}))||void 0===o?void 0:o.payload,d=null==i?void 0:i.username,c=yield a.User.findOne({username:d});if(!c)return void t.status(401).json("Not authorized");if(n)return"TokenExpiredError"===(null==n?void 0:n.name)?s.default.verify(c.token.refresh,process.env.JWT_SECRET,((e,n)=>r(this,void 0,void 0,(function*(){if(e)return void t.status(401).json("Not authorized, "+e.name);const{access:n,refresh:r}=(0,u.default)(c.username);c.token={access:n,refresh:r},yield c.save(),t.status(200).json(n)})))):t.status(401).json("Not authorized, "+(null==n?void 0:n.name));const{access:l,refresh:f}=(0,u.default)(c.username);c.token={access:l,refresh:f},yield c.save(),t.status(200).json(l)}))))}}catch(e){console.log(e),t.status(401).json("Not authhorized, \n"+(null==e?void 0:e.message))}}))}register(e,t){var n,o;return r(this,void 0,void 0,(function*(){try{const{organization:r}=e.body;let d=e.headers.authorization;d=d&&d.split(" ")[1];const c=null===(o=null===(n=s.default.decode(d,{complete:!0}))||void 0===n?void 0:n.payload)||void 0===o?void 0:o.username;if(yield a.User.findOne({username:c}))return t.status(200).json({isNew:!1});const{access:l,refresh:f,username:p}=(0,u.default)(),h=new i.default.Types.ObjectId,y=new i.default.Types.ObjectId,g=new i.default.Types.ObjectId;yield a.Cart.create({_id:y,user:h,products:[]}),yield a.Order.create({user:h,orders:[]}),yield a.Favorite.create({_id:g,user:h,products:[]}),yield a.User.create({_id:h,token:{access:l,refresh:f},cart:y,favorite:g,organization:r,username:p}),t.status(200).json({isNew:!0,access:l})}catch(e){console.log(e),t.status(500).json("Server error")}}))}updateProfile(e,t){return r(this,void 0,void 0,(function*(){const{username:n,phone:r,email:o,organization:i,name:s}=e.body;try{const e=yield a.User.findOneAndUpdate({username:n},{name:s,phone:r,email:o,organization:i},{fields:{token:0,cart:0,organization:0}});t.status(200).json({message:"ok",user:e})}catch(e){console.log(e),t.status(500).json("Server error")}}))}getProfile(e,t){return r(this,void 0,void 0,(function*(){const n=e.body.username;try{const e=yield a.User.findOne({username:n},{token:0,_id:0}).populate({path:"organization",populate:{path:"city"}}).populate({path:"cart",populate:{path:"products.product"},select:{user:0,_id:0}});if(!e.organization)return t.status(200).json({isAuth:!1,user:e});const r=yield(0,d.default)(e.cart.products,e.organization._id);t.status(200).json({isAuth:!0,user:Object.assign(Object.assign({},e._doc),{cart:{totalPrice:e.cart.totalPrice,products:r}})})}catch(e){console.log(e),t.status(500).json("Server error")}}))}}},978:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(45),s=o(n(992)),a=o(n(354)),u=o(n(215)),d=o(n(829)),c=n(64),l=o(n(90)),f=o(n(610));t.default=class{addToCart(e,t){return r(this,void 0,void 0,(function*(){const{product:n,username:r}=e.body;try{const e=yield i.User.findOne({username:r});if(!e)throw Error("Bad request");if(!(yield i.Product.findOne({organization:e.organization,"products.id":n})))throw Error("Bad request");let o=yield i.Cart.findOne({_id:e.cart});const s=o.products.find((e=>e.product===n));o=s?yield i.Cart.findOneAndUpdate({_id:e.cart,"products.product":n},{$inc:{"products.$.amount":1}},{new:!0}):yield i.Cart.findOneAndUpdate({_id:e.cart},{$push:{products:{product:n}}},{new:!0});const d=yield(0,a.default)(o.products,e.organization),c=yield(0,u.default)(d,o._id);t.status(200).json({products:d,totalPrice:c})}catch(e){console.log(e),t.status(400).json("Bad request")}}))}addToFavorite(e,t){return r(this,void 0,void 0,(function*(){try{const{username:n,productId:r}=e.body,o=yield i.User.findOne({username:n}),s=yield i.Product.aggregate([{$unwind:"$products"},{$match:{organization:o.organization,"products.id":r}},{$project:{products:1}}]);if(!s.length)throw Error("Product not found");console.log(s[0]);const a=yield l.default.findOne({user:o._id,"products.id":r});let u={};const d={isActive:!1};a?(u={$pull:{products:{id:r}}},d.isActive=!1):(u={$push:{products:s[0].products}},d.isActive=!0),yield l.default.updateOne({user:o._id},u),t.status(200).json(Object.assign({message:"success"},d))}catch(e){console.log(e),t.status(400).json("Bad request")}}))}removeOne(e,t){return r(this,void 0,void 0,(function*(){const{username:n,cart:r}=e.body;try{const e=yield i.User.findOne({username:n}),o=yield i.Cart.findOneAndUpdate({_id:e.cart,"products._id":r},{$pull:{products:{_id:r}}},{new:!0}),s=yield(0,a.default)(o.products,e.organization),d=yield(0,u.default)(s,r._id);t.status(200).json({products:s,totalPrice:d})}catch(e){console.log(e),t.status(400).json("Bad request")}}))}clear(e,t){return r(this,void 0,void 0,(function*(){const n=e.body.username;try{const e=yield i.User.findOne({username:n});if(yield i.Cart.findOneAndUpdate({_id:e.cart},{$set:{products:[]}},{new:!0}),!e)throw Error();t.status(200).json({products:[],totalPrice:0})}catch(e){console.log(e),t.status(400).json("Bad request")}}))}changeAmount(e,t){return r(this,void 0,void 0,(function*(){try{const n=e.body.type,{cart:r,username:o,count:s}=e.body;let d={};const c=yield i.User.findOne({username:o});switch(n){case"inc":d=1;break;case"dec":d=-1;break;default:throw Error("Bad request")}let l=yield i.Cart.findOne({_id:c.cart,"products._id":r});const f=s;console.log(s),l=yield i.Cart.findOneAndUpdate({_id:c.cart,"products._id":r},{$set:{"products.$.amount":f}},{new:!0});const p=yield(0,a.default)(l.products,c.organization),h=yield(0,u.default)(p,r._id);t.status(200).json({products:p,totalPrice:h})}catch(e){console.log(e),t.status(400).json("Bad request")}}))}getCart(e,t){return r(this,void 0,void 0,(function*(){const n=e.body.username;try{const e=yield i.User.findOne({username:n}),r=yield i.Cart.findOne({_id:e.cart}),o=yield(0,a.default)(r.products,e.organization),s=yield(0,u.default)(o,r._id);t.status(200).json({products:o,totalPrice:s})}catch(e){console.log(e),t.status(400).json("Bad request")}}))}createOrder(e,t){return r(this,void 0,void 0,(function*(){const{username:n,address:r,comment:o,phone:u,date:l,promocode:p,cart_choice:h,name:y,payment:g,times:v,notCall:m}=e.body;try{const e=yield i.User.findOne({username:n});if(!e)throw Error();const h=yield(0,c.separateAddress)(r);if(200!==h.status)return t.status(h.status).json(h.message);const g=yield i.Cart.findOne({_id:e.cart}),m=yield(0,a.default)(g.products,e.organization),_=yield(0,f.default)(m);if(Object.keys(_).length>0)return t.status(200).json({success:!1,errors:_});const{locality:O,street:b,house:j}=h.separateAddressObject,$=(0,s.default)({locality:O,street:b,house:j},e.organization,{name:y,comment:o,date:l,phone:u,times:v,promocode:p},m),{status:w,message:P}=yield d.default.iikoMethodBuilder((()=>d.default.createOrder($)));if(console.log(w),200!==w)return t.status(w).json({status:!1,message:P});yield i.Cart.updateOne({_id:e.cart},{$set:{products:[],totalPrice:0}},{new:!1}),yield i.Order.findOneAndUpdate({user:e._id},{$push:{orders:{products:g.products,totalPrice:g.totalPrice}}});const S=yield i.Order.aggregate([{$project:{orders:1}},{$unwind:"$orders"},{$group:{_id:null,count:{$sum:1}}}]);yield i.User.updateOne({username:n},{isVerify:!0,phone:u,name:y}),t.status(200).json({success:!0,orderNumber:S[0].count})}catch(e){console.log(e),t.status(404).json({success:!1,messsage:e})}}))}}},915:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(185));t.default=function(){return r(this,void 0,void 0,(function*(){yield i.default.connect(process.env.mongo_connect_url),console.log("success connect to mongo deliverycx")}))}},72:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=n(185),o=new r.Schema({_id:{required:!0,type:String},name:{required:!0,type:String}},{versionKey:!1});t.default=(0,r.model)("Category",o)},453:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=n(185),o=new r.Schema({classifierId:{required:!0,type:String},additionalInfo:{required:!0,type:String},externalRevision:{required:!0,type:Number},name:{required:!0,type:String}},{versionKey:!1});t.default=(0,r.model)("City",o)},861:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=n(185),o=new r.Schema({_id:{required:!0,type:String},name:{required:!0,type:String},code:{required:!0,type:String},order:{required:!0,type:Number},image:{required:!0,type:String},isIncludedInMenu:{required:!0,type:Boolean}},{versionKey:!1});t.default=(0,r.model)("Group",o)},190:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(185)),a=new s.Schema({_id:{required:!0,type:String},city:{required:!0,type:s.default.Types.ObjectId,ref:"City"},longitude:{required:!0,type:Number},latitude:{required:!0,type:Number},street:{required:!0,type:String},contacts:{phone:{required:!0,type:String},email:String},products:{required:!0,type:s.default.Types.ObjectId,ref:"product"}},{versionKey:!1});t.default=(0,s.model)("Organization",a)},169:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ProductSchema=void 0;const r=n(185);t.ProductSchema=new r.Schema({id:String,name:{required:!0,type:String},code:{required:!0,type:String},price:{required:!0,type:Number},image:{required:!0,type:String},isIncludedInMenu:{required:!0,type:Boolean},order:Number,group:{required:!0,type:String,ref:"Group"},category:{required:!0,type:String,ref:"Category"},weight:{required:!0,type:Number},measureUnit:{required:!0,type:String},description:{required:!0,type:String},additionalInfo:{required:!0,type:String}});const o=new r.Schema({organization:{ref:"organization",type:String},products:[t.ProductSchema],revision:Number},{versionKey:!1});t.default=(0,r.model)("Products",o)},45:function(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Order=t.Cart=t.User=t.Product=t.Organization=t.Group=t.City=t.Favorite=t.Category=void 0;const o=r(n(72));t.Category=o.default;const i=r(n(453));t.City=i.default;const s=r(n(861));t.Group=s.default;const a=r(n(190));t.Organization=a.default;const u=r(n(169));t.Product=u.default;const d=r(n(726));t.Cart=d.default;const c=r(n(993));t.Order=c.default;const l=r(n(90));t.Favorite=l.default;const f=r(n(983));t.User=f.default},983:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(185)),a=new s.Schema({token:{access:{required:!0,type:String},refresh:{required:!0,type:String}},favorite:{ref:"Favorite",type:s.default.Types.ObjectId},cart:{ref:"Cart",type:s.default.Types.ObjectId},username:String,name:{required:!1,type:String},phone:{required:!1,type:String},isVerify:{required:!0,type:Boolean,default:!1},organization:{type:String,ref:"Organization"},orderHistory:{type:s.default.Types.ObjectId,ref:"Order"}},{versionKey:!1});t.default=(0,s.model)("User",a)},726:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.CartSchema=void 0;const s=i(n(185));t.CartSchema=new s.Schema({user:{required:!0,ref:"User",type:s.default.Types.ObjectId},products:[{product:String,amount:{type:Number,default:1,min:1}}],totalPrice:{required:!0,default:0,type:Number}},{versionKey:!1});const a=(0,s.model)("Cart",t.CartSchema);t.default=a},90:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(185)),a=n(169),u=new s.Schema({user:{ref:"User",type:s.default.Types.ObjectId},products:[a.ProductSchema]},{versionKey:!1});t.default=(0,s.model)("Favorite",u)},993:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=n(185),o=new r.Schema({user:{type:r.Types.ObjectId,ref:"User"},orders:[{products:[{product:{type:String,ref:"Products"},amount:Number}],date:{type:Date,default:Date.now},totalPrice:Number}]},{versionKey:!1}),i=(0,r.model)("Order",o);t.default=i},992:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,n,r){try{const{phone:o,name:i,comment:s}=n;return{organization:t,customer:{name:i,phone:o},order:{date:"2021-09-28 12:00:00",phone:o,isSelfService:"false",items:r.map((e=>({id:e.product.id,name:e.product.name,amount:e.amount,code:e.product.code,sum:e.product.price}))),address:{city:e.locality,street:e.street.split(" ")[1],home:e.house,comment:s}}}}catch(e){return console.log(e),{}}}},792:function(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(344));t.default=function(e=null){let t;return t=e||`u_${Math.random().toString(36).substr(2,9)}`,{access:o.default.sign({username:t},process.env.JWT_SECRET,{expiresIn:"7d"}),refresh:o.default.sign({username:t},process.env.JWT_SECRET,{expiresIn:"30d"}),username:t}}},64:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.separateAddress=t.geoCode=void 0;const i=o(n(167)),s=n(435);function a(e,t){var n;const r=(new s.DOMParser).parseFromString(e,"text/xml"),o=t.split(" ");let i=r.documentElement.getElementsByTagName(o[0])[0];if(i=null===(n=i.getElementsByTagName(o[1])[0].firstChild)||void 0===n?void 0:n.textContent,"string"==typeof i){const[e,t]=i.split(" ");return{longitude:+e,latitude:+t}}return null}t.geoCode=function(e){return r(this,void 0,void 0,(function*(){try{const t=encodeURI(e),n=yield i.default.get(`https://geocode-maps.yandex.ru/1.x/?apikey=${process.env.yandex_apiKey}&geocode=${t}`);return 200!==n.status?null:a(n.data,"Point pos")}catch(e){return console.log(e),null}}))},t.separateAddress=function(e){return r(this,void 0,void 0,(function*(){e=encodeURI(e);const{data:t,status:n}=yield i.default.get(`https://geocode-maps.yandex.ru/1.x/?geocode=${e}&format=json&apikey=${process.env.yandex_apiKey}`);if(console.log(t),200!==n)return{status:n,message:"Something went wrong"};if(0==+t.response.GeoObjectCollection.metaDataProperty.GeocoderResponseMetaData.found)return{status:400,message:"Не верно задан адрес"};const r={};return t.response.GeoObjectCollection.featureMember[0].GeoObject.metaDataProperty.GeocoderMetaData.Address.Components.forEach((e=>{r[e.kind]=e.name})),{status:200,message:"OK",separateAddressObject:r}}))},t.default=a},354:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(169));t.default=function(e,t){return r(this,void 0,void 0,(function*(){const n=[];for(let r in e){const o=e[r],s=yield i.default.aggregate([{$unwind:"$products"},{$match:{organization:t,"products.id":o.product}},{$project:{_id:0,organization:0}},{$group:{_id:null,product:{$addToSet:"$products"}}}]);s.length&&n.push({product:s[0].product[0],_id:o._id,amount:o.amount})}return n}))}},63:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.parseOrganization=void 0,t.parseOrganization=function(e){var t;const n=null===(t=e.address.match(/^(?<city>[а-я]+),\s?(?<address>[а-я0-9\s]+)$/i))||void 0===t?void 0:t.groups;return{id:e.id,address:{fulladdress:e.address,city:n?n.city.trim():null,address:n?n.address.trim():null},contacts:{phone:e.contact.phone,email:e.contact.email}}}},902:function(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),r(n(142)).default.config();const o=r(n(860)),i=r(n(986)),s=r(n(582)),a=r(n(17)),u=r(n(915)),d=r(n(829)),c=r(n(707)),l=r(n(370)),f=r(n(574)),p=r(n(753)),h=a.default.resolve(__dirname,"../../client/build/index.html"),y=(0,o.default)(),g=process.env.PORT||5001;y.use(o.default.static(a.default.resolve(__dirname,"../../client/build"))),y.use((0,s.default)()),y.use((0,i.default)()),y.use("/api",c.default),y.use("/profile",f.default),y.use("/shop",p.default,l.default),y.get("/*",((e,t)=>{t.sendFile(h)})),y.listen(g,(()=>{try{console.log(`starting on ${g}`),(0,u.default)().then((()=>{d.default.pooling()})).catch((e=>console.log(e)))}catch(e){console.log(e)}}))},753:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(344)),s=n(45),a=o(n(792));t.default=function(e,t,n){return r(this,void 0,void 0,(function*(){const o=e.headers.authorization;yield new Promise(((e,t)=>{o||t("Not authorized");const n=o.split(" ")[1];i.default.verify(n,process.env.JWT_SECRET,(o=>r(this,void 0,void 0,(function*(){var a,u;const d=null===(u=null===(a=i.default.decode(n,{complete:!0}))||void 0===a?void 0:a.payload)||void 0===u?void 0:u.username,c=yield s.User.findOne({username:d});if(!c)return t();o?"TokenExpiredError"===o.name?i.default.verify(c.token.refresh,process.env.JWT_SECRET,(n=>r(this,void 0,void 0,(function*(){n?t():e(d)})))):t():e(d)}))))})).then((r=>{const{access:o,refresh:i}=(0,a.default)(r);s.User.findOneAndUpdate({username:r},{$set:{token:{access:o,refresh:i}}}).then((()=>{e.body.username=r,n()})).catch((e=>{console.log(e),t.status(401).json({isAuth:!1})}))})).catch((e=>{console.log(e),t.status(401).json({isAuth:!1})}))}))}},707:function(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(860)),i=r(n(753)),s=o.default.Router(),a=new(r(n(493)).default);s.get("/getCities",a.getCities),s.get("/getAddresses",a.getAddresses),s.get("/getCategories",a.getCategories),s.get("/getProducts",i.default,a.getProducts),s.get("/getProduct/:id",i.default,a.getProduct),t.default=s},574:function(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(860)),i=r(n(494)),s=r(n(753)),a=o.default.Router(),u=new i.default;a.post("/login",u.login.bind(u)),a.post("/register",u.register.bind(u)),a.post("/getProfile",s.default,u.getProfile.bind(u)),a.post("/update",u.updateProfile.bind(u)),t.default=a},370:function(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(860)).default.Router(),i=new(r(n(978)).default);o.post("/addToCart",i.addToCart),o.post("/addToFavorite",i.addToFavorite),o.post("/createOrder",i.createOrder),o.get("/getCart",i.getCart),o.patch("/changeAmount",i.changeAmount),o.delete("/remove",i.removeOne),o.delete("/clear",i.clear),t.default=o},829:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const u=a(n(167)),d=n(63),c=i(n(45)),l=n(64);class f{constructor(){this.organizations=[]}iikoMethodBuilder(e){return s(this,void 0,void 0,(function*(){return yield this.getToken(),yield e()}))}static getInstance(){return f._instance||(f._instance=new f),f._instance}get token(){return f.token}getToken(){return s(this,void 0,void 0,(function*(){try{const e=yield u.default.get(`https://iiko.biz:9900/api/0/auth/access_token?user_id=${process.env.iiko_user}&user_secret=${process.env.iiko_password}`);f.token=e.data}catch(e){console.log(`Error with get token\n${e}`)}}))}getOrganizations(){return s(this,void 0,void 0,(function*(){try{console.log("starting get organizations");const e=yield u.default.get(`https://iiko.biz:9900/api/0/organization/list?access_token=${f.token}`);this.organizations=e.data.map((e=>(0,d.parseOrganization)(e)))}catch(e){console.log(`Error with get organizations\n${e}`)}}))}createOrder(e){return s(this,void 0,void 0,(function*(){try{const{data:t}=yield u.default.post(`https://iiko.biz:9900/api/0/orders/checkCreate?access_token=${f.token}`,e);if(0!==t.resultState)return{status:400,message:t.problem};const{data:n}=yield u.default.post(`https://iiko.biz:9900/api/0/orders/add?access_token=${f.token}`,e);return{status:200,message:n}}catch(e){return{status:e.response.data.httpStatusCode,message:e.response.data.description}}}))}getAndSaveNomenclature(){return s(this,void 0,void 0,(function*(){try{for(let e in this.organizations){const t=yield u.default.get(`https://iiko.biz:9900/api/0/nomenclature/${this.organizations[e].id}?access_token=${f.token}`),n=this.organizations[e],r={products:t.data.products,groups:t.data.groups,categories:t.data.productCategories,revision:t.data.revision},o=yield c.City.findOneAndUpdate({name:n.address.city},{$setOnInsert:{name:n.address.city}},{new:!0,upsert:!0});yield Promise.all(r.categories.map((e=>s(this,void 0,void 0,(function*(){yield c.Category.findOneAndUpdate({_id:e.id},Object.assign(Object.assign({},e),{_id:e.id}),{upsert:!0})}))))),yield Promise.all(r.groups.map((e=>s(this,void 0,void 0,(function*(){yield c.Group.findOneAndUpdate({_id:e.id},Object.assign(Object.assign({},e),{image:e.images[e.images.length-1].imageUrl,_id:e.id}),{upsert:!0})})))));const i=yield c.Product.findOneAndUpdate({organization:n.id},{$setOnInsert:{organization:n.id},revision:r.revision,$set:{products:r.products.map((e=>{var t;return Object.assign(Object.assign({},e),{image:null===(t=e.images[e.images.length-1])||void 0===t?void 0:t.imageUrl,category:e.productCategoryId,group:e.parentGroup})}))}},{new:!0,upsert:!0}),a=yield(0,l.geoCode)(n.address.fulladdress);yield c.Organization.findOneAndUpdate({_id:n.id},{$setOnInsert:{_id:n.id,city:o._id,street:n.address.address,longitude:null==a?void 0:a.longitude,latitude:null==a?void 0:a.latitude,contacts:Object.assign({},n.contacts),products:i._id}},{new:!0,upsert:!0})}}catch(e){console.log(`Error with get products\n${e}`)}}))}pooling(){return s(this,void 0,void 0,(function*(){console.log("start pooling"),yield this.getToken(),yield this.getOrganizations(),yield this.getAndSaveNomenclature(),console.log("end pooling")}))}}f.token="",t.default=f.getInstance()},215:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(726));t.default=function(e,t){return r(this,void 0,void 0,(function*(){const n=e.reduce(((e,t)=>e+t.amount*t.product.price),0);return yield i.default.updateOne({_id:t},{totalPrice:n}),n}))}},610:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(147)),s=o(n(17));t.default=function(e){return r(this,void 0,void 0,(function*(){const t=JSON.parse(i.default.readFileSync(s.default.resolve(__dirname,"./validationSchema.json"),{encoding:"utf-8"}));let n={};return e.forEach((r=>{const o=r.product.code.replace(/\W|\d+/gi,""),i=t.find((e=>e.product_code===o));if(i)if(!0===i.total_amount){const t=e.filter((e=>e.product.code.match(o))).reduce(((e,t)=>e+t.amount),0);(t<i.min_amount||t>i.max_amount)&&(n[o]={message:`Заказ на доставку от ${i.min_amount} шт. Пожалуйста добавьте еще.`})}else(r.amount<i.min_amount||r.amount>i.max_amount)&&(n[o]={message:`Заказ на доставку от ${i.min_amount} шт. Пожалуйста добавьте еще.`})})),n}))}},167:e=>{e.exports=require("axios")},986:e=>{e.exports=require("body-parser")},582:e=>{e.exports=require("cors")},142:e=>{e.exports=require("dotenv")},860:e=>{e.exports=require("express")},344:e=>{e.exports=require("jsonwebtoken")},185:e=>{e.exports=require("mongoose")},435:e=>{e.exports=require("xmldom")},147:e=>{e.exports=require("fs")},17:e=>{e.exports=require("path")}},t={};!function n(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports}(902)})();